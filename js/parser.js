!function(e,t){"function"==typeof define&&define.amd?define(["exports"],t):"undefined"!=typeof exports?t(exports):t(e)}(this,function(e){function t(e){function t(){switch(l.tokenType){case"(":case"[":case"{":return n();case"FUNCTION":return s();default:return l}}function n(){for(var e={"(":")","[":"]","{":"}"}[l.tokenType],n=new p(l.tokenType);;)switch(v(),l.tokenType){case"EOF":case e:return n;default:n.append(t())}}function s(){for(var e=new c(l.value),n=new i;;)switch(v(),l.tokenType){case"EOF":case")":return e.append(n),e;case"DELIM":","==l.value?(e.append(n),n=new i):n.append(l);break;default:n.append(t())}}for(var l,f="top-level",y=-1,d=new r,h=[d],k=h[0],v=function(t){return void 0===t&&(t=1),y+=t,l=y<e.length?e[y]:new EOFToken,!0},T=function(){return y--,!0},E=function(){return e[y+1]},b=function(e){return void 0===e?""!==k.fillType?f=k.fillType:"STYLESHEET"==k.type?f="top-level":(console.log("Unknown rule-type while switching to current rule's content mode: ",k),f=""):f=e,!0},m=function(e){return k=e,h.push(k),!0},w=function(e){return console.log("Parse error at token "+y+": "+l+".\n"+e),!0},O=function(){var e=h.pop();return k=h[h.length-1],k.append(e),!0},S=function(){return h.pop(),k=h[h.length-1],!0},N=function(){for(;h.length>1;)O()};;)if(v(),"DELIM"!==l.tokenType||"\r"!==l.value)switch(f){case"top-level":switch(l.tokenType){case"CDO":case"CDC":case"WHITESPACE":break;case"AT-KEYWORD":m(new a(l.value))&&b("at-rule");break;case"{":w("Attempt to open a curly-block at top-level.")&&t();break;case"EOF":return N(),d;default:m(new o)&&b("selector")&&T()}break;case"at-rule":switch(l.tokenType){case";":O()&&b();break;case"{":""!==k.fillType?b(k.fillType):w("Attempt to open a curly-block in a statement-type at-rule.")&&S()&&b("next-block")&&T();break;case"EOF":return N(),d;default:k.appendPrelude(t())}break;case"rule":switch(l.tokenType){case"WHITESPACE":break;case"}":O()&&b();break;case"AT-KEYWORD":m(new a(l.value))&&b("at-rule");break;case"EOF":return N(),d;default:m(new o)&&b("selector")&&T()}break;case"selector":switch(l.tokenType){case"{":b("declaration");break;case"EOF":return S()&&N(),d;default:k.appendSelector(t())}break;case"declaration":switch(l.tokenType){case"WHITESPACE":case";":break;case"}":O()&&b();break;case"AT-RULE":m(new a(l.value))&&b("at-rule");break;case"IDENT":m(new u(l.value))&&b("after-declaration-name");break;case"EOF":return N(),d;default:w()&&S()&&b("next-declaration")}break;case"after-declaration-name":switch(l.tokenType){case"WHITESPACE":break;case":":b("declaration-value");break;case";":w("Incomplete declaration - semicolon after property name.")&&S()&&b();break;case"EOF":return S()&&N(),d;default:w("Invalid declaration - additional token after property name")&&S()&&b("next-declaration")}break;case"declaration-value":switch(l.tokenType){case"DELIM":"!"==l.value&&"IDENTIFIER"==E().tokenType&&"important"==E().value.toLowerCase()?(v(),k.important=!0,b("declaration-end")):k.append(l);break;case";":O()&&b();break;case"}":O()&&O()&&b();break;case"EOF":return N(),d;default:k.append(t())}break;case"declaration-end":switch(l.tokenType){case"WHITESPACE":break;case";":O()&&b();break;case"}":O()&&O()&&b();break;case"EOF":return N(),d;default:w("Invalid declaration - additional token after !important.")&&S()&&b("next-declaration")}break;case"next-block":switch(l.tokenType){case"{":t()&&b();break;case"EOF":return N(),d;default:t()}break;case"next-declaration":switch(l.tokenType){case";":b("declaration");break;case"}":b("declaration")&&T();break;case"EOF":return N(),d;default:t()}break;default:return console.log("Unknown parsing mode: "+f),void 0}}function n(){return this}function r(){return this.value=[],this}function a(e){return this.name=e,this.prelude=[],this.value=[],e in a.registry&&(this.fillType=a.registry[e]),this}function o(){return this.selector=[],this.value=[],this}function u(e){return this.name=e,this.value=[],this}function p(e){return this.name=e,this.value=[],this}function c(e){return this.name=e,this.value=[],this}function i(){return this.value=[],this}n.prototype.fillType="",n.prototype.toString=function(e){return JSON.stringify(this.toJSON(),null,e)},n.prototype.append=function(e){return this.value.push(e),this},r.prototype=new n,r.prototype.type="STYLESHEET",r.prototype.toJSON=function(){return{type:"stylesheet",value:this.value.map(function(e){return e.toJSON()})}},a.prototype=new n,a.prototype.type="AT-RULE",a.prototype.appendPrelude=function(e){return this.prelude.push(e),this},a.prototype.toJSON=function(){return{type:"at",name:this.name,prelude:this.prelude.map(function(e){return e.toJSON()}),value:this.value.map(function(e){return e.toJSON()})}},a.registry={"import":"",media:"rule","font-face":"declaration",page:"declaration",keyframes:"rule",namespace:"","counter-style":"declaration",supports:"rule",document:"rule","font-feature-values":"declaration",viewport:"","region-style":"rule"},o.prototype=new n,o.prototype.type="STYLE-RULE",o.prototype.fillType="declaration",o.prototype.appendSelector=function(e){return this.selector.push(e),this},o.prototype.toJSON=function(){return{type:"selector",selector:this.selector.map(function(e){return e.toJSON()}),value:this.value.map(function(e){return e.toJSON()})}},u.prototype=new n,u.prototype.type="DECLARATION",u.prototype.toJSON=function(){return{type:"declaration",name:this.name,value:this.value.map(function(e){return e.toJSON()})}},p.prototype=new n,p.prototype.type="BLOCK",p.prototype.toJSON=function(){return{type:"block",name:this.name,value:this.value.map(function(e){return e.toJSON()})}},c.prototype=new n,c.prototype.type="FUNCTION",c.prototype.toJSON=function(){return{type:"func",name:this.name,value:this.value.map(function(e){return e.toJSON()})}},i.prototype=new n,i.prototype.type="FUNCTION-ARG",i.prototype.toJSON=function(){return this.value.map(function(e){return e.toJSON()})},e.parse=t});